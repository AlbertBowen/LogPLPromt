<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>pacman/Restore local database - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.39.4">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Pacman_Restore_local_database rootpage-Pacman skin-vector-2022 action-view skin--responsive vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled">
<div class="mw-page-container">
	<span id="top-page"></span>
	<a class="mw-jump-link" href="#content">Jump to content</a>
	<div class="mw-page-container-inner">
		<input type="checkbox" id="mw-sidebar-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="vector-sidebar-container vector-sidebar-container-no-toc">
			</div>
		<div class="vector-sitenotice-container">
			<div id="siteNotice"></div>
		</div>
		<input type="checkbox" id="vector-toc-collapsed-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="mw-table-of-contents-container">
			<div class="vector-sticky-toc-container mw-sticky-header-element">
				
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<a id="top"></a>
				<nav class="vector-article-toolbar" aria-label="Tools" role="navigation">
					<div class="mw-article-toolbar-container">
						<div id="left-navigation">
							

<div id="p-associated-pages" class="vector-menu mw-portlet mw-portlet-associated-pages vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-nstab-main" class="selected mw-list-item"><a href="../../en/Pacman/Restore_local_database.html" title="View the content page [c]" accesskey="c"><span>Page</span></a></li>
<li id="ca-talk" class="mw-list-item"><a href="../../en/Talk:Pacman/Restore_local_database.html" rel="discussion" title="Discussion about the content page [t]" accesskey="t"><span>Discussion</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-label="Change language variant">
	<label id="p-variants-label" for="p-variants-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

						</div>
						<div id="right-navigation" class="vector-collapsible ">
							

<div id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-view" class="selected mw-list-item"><a href="../../en/Pacman/Restore_local_database.html"><span>Read</span></a></li>
<li id="ca-viewsource" class="mw-list-item"><a href="/index.php?title=Pacman/Restore_local_database&amp;action=edit" title="This page is protected.
You can view its source [e]" accesskey="e"><span>View source</span></a></li>
<li id="ca-history" class="mw-list-item"><a href="/index.php?title=Pacman/Restore_local_database&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown vector-has-collapsible-items" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox">
	<label id="p-cactions-label" for="p-cactions-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="../../en/Pacman/Restore_local_database.html"><span>Read</span></a></li>
<li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Pacman/Restore_local_database&amp;action=edit"><span>View source</span></a></li>
<li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Pacman/Restore_local_database&amp;action=history"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

						</div>
					</div>
				</nav>
				<div id="bodyContent" class="vector-body" data-mw-ve-target-container>
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        </div>

					    <div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><span class="subpages">&lt; <a href="../../en/Pacman.html" title="Pacman">Pacman</a></span></div>
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<p><span>
</span>
Signs that pacman needs a local database restoration:
</p>
<ul>
<li>
<code>pacman -Q</code> gives absolutely no output, and <code>pacman -Syu</code> erroneously reports that the system is up to date.</li>
<li>When trying to install a package using <code>pacman -S package</code>, and it outputs a list of already satisfied dependencies.</li>
</ul>
<p>Most likely, pacman's database of installed software, <code>/var/lib/pacman/local</code>, has been corrupted or deleted. While this is a serious problem, it can be restored by following the instructions below.
</p>
<p>Firstly, make sure pacman's log file is present:
</p>
<pre>$ ls /var/log/pacman.log
</pre>
<p>If it does not exist, it is <i>not</i> possible to continue with this method. You may be able to use <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=670876">Xyne's package detection script</a> to recreate the database. If not, then the likely solution is to re-install the entire system.
</p>
<h2><span class="mw-headline" id="Generating_the_package_recovery_list">Generating the package recovery list</span></h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If for some reason your <a href="../../en/Pacman.html" title="Pacman">pacman</a> cache or <a href="../../en/Makepkg.html" title="Makepkg">makepkg</a> package destination contain packages for other architectures, remove them before continuation.</div>
<p><a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pacutils">pacutils</a></span> package to get <i>paclog</i>.
</p>
<p>Create the log filter script and make it <a href="../../en/Help:Reading.html#Make_executable" class="mw-redirect" title="Executable">executable</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">pacrecover</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash -e

. /etc/makepkg.conf

PKGCACHE=$((grep -m 1 '^CacheDir' /etc/pacman.conf || echo 'CacheDir = /var/cache/pacman/pkg') | sed 's/CacheDir = //')

pkgdirs=("$@" "$PKGDEST" "$PKGCACHE")

while read -r -a parampart; do
  pkgname="${parampart[0]}-${parampart[1]}-*.pkg.tar.{xz,zst}"
  for pkgdir in ${pkgdirs[@]}; do
    pkgpath="$pkgdir"/$pkgname
    [ -f $pkgpath ] &amp;&amp; { echo $pkgpath; break; };
  done || echo ${parampart[0]} 1&gt;&amp;2
done
</pre>
<p>Run the script (optionally passing additional directories with packages as parameters):
</p>
<pre>$ paclog --pkglist --logfile=/var/log/pacman.log | ./pacrecover &gt;files.list 2&gt;pkglist.orig
</pre>
<p>This way two files will be created: <code>files.list</code> with package files, still present on machine and <code>pkglist.orig</code>, packages from which should be downloaded. Later operation may result in mismatch between files of older versions of package, still present on machine, and files, found in new version. Such mismatches will have to be fixed manually.
</p>
<p>Here is a way to automatically restrict second list to packages available in a repository:
</p>
<pre>$ { cat pkglist.orig; pacman -Slq; } | sort | uniq -d &gt; pkglist
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If this fails with <code>failed to initialise alpm library</code>, then check if <code>/var/lib/pacman/local/ALPM_DB_VERSION</code> exists - if not, then run <code>pacman-db-upgrade</code> as root followed by <code>pacman -Sy</code> and then <b>retry the previous command</b>.</div>
<p>Check if some important <i>base</i> packages are missing, and add them to the list:
</p>
<pre>$ comm -23 &lt;(pacman -Sgq base | sort) pkglist.orig &gt;&gt; pkglist
</pre>
<p>Proceed once the contents of both lists are satisfactory, since they will be used to restore pacman's installed package database; <code>/var/lib/pacman/local/</code>.
</p>
<h2><span class="mw-headline" id="Performing_the_recovery">Performing the recovery</span></h2>
<p>Define a <a href="../../en/Bash/Functions.html" title="Bash/Functions">bash function</a> for recovery purposes:
</p>
<pre> recovery-pacman() {
    pacman "$@"  \
    --log /dev/null   \
    --noscriptlet     \
    --dbonly          \
    --overwrite "*"   \
    --nodeps          \
    --needed
}
</pre>
<p><code>--log /dev/null</code> allows to avoid needless pollution of pacman log, <code>--needed</code> will save some time by skipping packages, already present in database, <code>--nodeps</code> will allow installation of cached packages, even if packages being installed depend on newer versions. Rest of options will allow <b>pacman</b> to operate without reading/writing filesystem.
</p>
<p>Populate the sync database:
</p>
<pre># pacman -Sy
</pre>
<p>Start database generation by installing locally available package files from <code>files.list</code>:
</p>
<pre># recovery-pacman -U $(&lt; files.list)
</pre>
<p>Install the rest from <code>pkglist</code>:
</p>
<pre># recovery-pacman -S $(&lt; pkglist)
</pre>
<p>Update the local database so that packages that are not required by any other package are marked as explicitly installed and the other as dependences. You will need to be extra careful in the future when removing packages, but with the original database lost, it is the best we can do.
</p>
<pre># pacman -D --asdeps $(pacman -Qq)
# pacman -D --asexplicit $(pacman -Qtq)
</pre>
<p>Optionally check all installed packages for corruption:
</p>
<pre># pacman -Qk
</pre>
<p>Optionally <a href="../../en/Pacman/Tips_and_tricks.html#Identify_files_not_owned_by_any_package" title="Pacman/Tips and tricks">Pacman/Tips and tricks#Identify files not owned by any package</a>.
</p>
<p>Update all packages:
</p>
<pre># pacman -Su
</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Package_manager.html" title="Category:Package manager">Package manager</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Pacman/Restore_local_database&amp;oldid=758415">https://wiki.archlinux.org/index.php?title=Pacman/Restore_local_database&amp;oldid=758415</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 29 November 2022, at 07:06.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimer"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
</ul>

	
</footer>

		</div>
	</div> 
</div> 

</body>
</html>
