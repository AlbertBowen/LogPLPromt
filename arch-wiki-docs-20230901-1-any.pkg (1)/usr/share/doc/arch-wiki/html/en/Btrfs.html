<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Btrfs - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.39.4">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Btrfs rootpage-Btrfs skin-vector-2022 action-view skin--responsive vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled">
<div class="mw-page-container">
	<span id="top-page"></span>
	<a class="mw-jump-link" href="#content">Jump to content</a>
	<div class="mw-page-container-inner">
		<input type="checkbox" id="mw-sidebar-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="vector-sidebar-container ">
			</div>
		<div class="vector-sitenotice-container">
			<div id="siteNotice"></div>
		</div>
		<input type="checkbox" id="vector-toc-collapsed-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="mw-table-of-contents-container">
			<div class="vector-sticky-toc-container mw-sticky-header-element">
				<nav id="mw-panel-toc" class="sidebar-toc" role="navigation" aria-labelledby="sidebar-toc-label" data-event-name="ui.sidebar-toc">
	<div id="sidebar-toc-label" class="sidebar-toc-header">
		<p class="sidebar-toc-title">
		Contents
		<button class="vector-toc-uncollapse-button">move to sidebar</button>
		<button class="vector-toc-collapse-button">hide</button>
		</p>
	</div>
	<ul class="sidebar-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a href="#top-page" class="sidebar-toc-link">
				<div class="sidebar-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Preparation" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Preparation">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">1</span>Preparation</div>
			</a>
			
			<ul id="toc-Preparation-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-File_system_creation" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#File_system_creation">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2</span>File system creation</div>
			</a>
			
				<button aria-controls="toc-File_system_creation-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle File system creation subsection
				</button>
			
			<ul id="toc-File_system_creation-sublist" class="sidebar-toc-list">
				<li id="toc-File_system_on_a_single_device" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#File_system_on_a_single_device">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.1</span>File system on a single device</div>
			</a>
			
			<ul id="toc-File_system_on_a_single_device-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Multi-device_file_system" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Multi-device_file_system">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.2</span>Multi-device file system</div>
			</a>
			
			<ul id="toc-Multi-device_file_system-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Configuring_the_file_system" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Configuring_the_file_system">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3</span>Configuring the file system</div>
			</a>
			
				<button aria-controls="toc-Configuring_the_file_system-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Configuring the file system subsection
				</button>
			
			<ul id="toc-Configuring_the_file_system-sublist" class="sidebar-toc-list">
				<li id="toc-Copy-on-Write_(CoW)" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Copy-on-Write_(CoW)">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.1</span>Copy-on-Write (CoW)</div>
			</a>
			
			<ul id="toc-Copy-on-Write_(CoW)-sublist" class="sidebar-toc-list">
				<li id="toc-Disabling_CoW" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Disabling_CoW">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.1.1</span>Disabling CoW</div>
			</a>
			
			<ul id="toc-Disabling_CoW-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Compression" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Compression">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.2</span>Compression</div>
			</a>
			
			<ul id="toc-Compression-sublist" class="sidebar-toc-list">
				<li id="toc-View_compression_types_and_ratios" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#View_compression_types_and_ratios">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.2.1</span>View compression types and ratios</div>
			</a>
			
			<ul id="toc-View_compression_types_and_ratios-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Subvolumes" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Subvolumes">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3</span>Subvolumes</div>
			</a>
			
			<ul id="toc-Subvolumes-sublist" class="sidebar-toc-list">
				<li id="toc-Creating_a_subvolume" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Creating_a_subvolume">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.1</span>Creating a subvolume</div>
			</a>
			
			<ul id="toc-Creating_a_subvolume-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Listing_subvolumes" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Listing_subvolumes">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.2</span>Listing subvolumes</div>
			</a>
			
			<ul id="toc-Listing_subvolumes-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Deleting_a_subvolume" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Deleting_a_subvolume">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.3</span>Deleting a subvolume</div>
			</a>
			
			<ul id="toc-Deleting_a_subvolume-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Mounting_subvolumes" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Mounting_subvolumes">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.4</span>Mounting subvolumes</div>
			</a>
			
			<ul id="toc-Mounting_subvolumes-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Mounting_subvolume_as_root" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Mounting_subvolume_as_root">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.5</span>Mounting subvolume as root</div>
			</a>
			
			<ul id="toc-Mounting_subvolume_as_root-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Changing_the_default_sub-volume" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Changing_the_default_sub-volume">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3.6</span>Changing the default sub-volume</div>
			</a>
			
			<ul id="toc-Changing_the_default_sub-volume-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Quota" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Quota">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.4</span>Quota</div>
			</a>
			
			<ul id="toc-Quota-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Commit_interval" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Commit_interval">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.5</span>Commit interval</div>
			</a>
			
			<ul id="toc-Commit_interval-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-SSD_TRIM" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#SSD_TRIM">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.6</span>SSD TRIM</div>
			</a>
			
			<ul id="toc-SSD_TRIM-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Usage" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Usage">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4</span>Usage</div>
			</a>
			
				<button aria-controls="toc-Usage-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Usage subsection
				</button>
			
			<ul id="toc-Usage-sublist" class="sidebar-toc-list">
				<li id="toc-Swap_file" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Swap_file">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.1</span>Swap file</div>
			</a>
			
			<ul id="toc-Swap_file-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Displaying_used/free_space" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Displaying_used/free_space">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.2</span>Displaying used/free space</div>
			</a>
			
			<ul id="toc-Displaying_used/free_space-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Defragmentation" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Defragmentation">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.3</span>Defragmentation</div>
			</a>
			
			<ul id="toc-Defragmentation-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-RAID" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#RAID">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.4</span>RAID</div>
			</a>
			
			<ul id="toc-RAID-sublist" class="sidebar-toc-list">
				<li id="toc-Scrub" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Scrub">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.4.1</span>Scrub</div>
			</a>
			
			<ul id="toc-Scrub-sublist" class="sidebar-toc-list">
				<li id="toc-Start_manually" class="sidebar-toc-list-item sidebar-toc-level-4">
			<a class="sidebar-toc-link" href="#Start_manually">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.4.1.1</span>Start manually</div>
			</a>
			
			<ul id="toc-Start_manually-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Start_with_a_service_or_timer" class="sidebar-toc-list-item sidebar-toc-level-4">
			<a class="sidebar-toc-link" href="#Start_with_a_service_or_timer">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.4.1.2</span>Start with a service or timer</div>
			</a>
			
			<ul id="toc-Start_with_a_service_or_timer-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Balance" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Balance">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.4.2</span>Balance</div>
			</a>
			
			<ul id="toc-Balance-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Snapshots" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Snapshots">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.5</span>Snapshots</div>
			</a>
			
			<ul id="toc-Snapshots-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Send/receive" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Send/receive">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.6</span>Send/receive</div>
			</a>
			
			<ul id="toc-Send/receive-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Deduplication" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Deduplication">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.7</span>Deduplication</div>
			</a>
			
			<ul id="toc-Deduplication-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Resizing" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Resizing">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4.8</span>Resizing</div>
			</a>
			
			<ul id="toc-Resizing-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Known_issues" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Known_issues">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5</span>Known issues</div>
			</a>
			
				<button aria-controls="toc-Known_issues-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Known issues subsection
				</button>
			
			<ul id="toc-Known_issues-sublist" class="sidebar-toc-list">
				<li id="toc-Encryption" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Encryption">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.1</span>Encryption</div>
			</a>
			
			<ul id="toc-Encryption-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-btrfs_check_issues" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#btrfs_check_issues">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.2</span>btrfs check issues</div>
			</a>
			
			<ul id="toc-btrfs_check_issues-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Tips_and_tricks" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Tips_and_tricks">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6</span>Tips and tricks</div>
			</a>
			
				<button aria-controls="toc-Tips_and_tricks-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Tips and tricks subsection
				</button>
			
			<ul id="toc-Tips_and_tricks-sublist" class="sidebar-toc-list">
				<li id="toc-Partitionless_Btrfs_disk" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Partitionless_Btrfs_disk">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.1</span>Partitionless Btrfs disk</div>
			</a>
			
			<ul id="toc-Partitionless_Btrfs_disk-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Ext3/4_to_Btrfs_conversion" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Ext3/4_to_Btrfs_conversion">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.2</span>Ext3/4 to Btrfs conversion</div>
			</a>
			
			<ul id="toc-Ext3/4_to_Btrfs_conversion-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Corruption_recovery" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Corruption_recovery">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.3</span>Corruption recovery</div>
			</a>
			
			<ul id="toc-Corruption_recovery-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Booting_into_snapshots" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Booting_into_snapshots">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.4</span>Booting into snapshots</div>
			</a>
			
			<ul id="toc-Booting_into_snapshots-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Use_Btrfs_subvolumes_with_systemd-nspawn" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Use_Btrfs_subvolumes_with_systemd-nspawn">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.5</span>Use Btrfs subvolumes with systemd-nspawn</div>
			</a>
			
			<ul id="toc-Use_Btrfs_subvolumes_with_systemd-nspawn-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Reducing_access_time_metadata_updates" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Reducing_access_time_metadata_updates">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.6</span>Reducing access time metadata updates</div>
			</a>
			
			<ul id="toc-Reducing_access_time_metadata_updates-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Incremental_backup_to_external_drive" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Incremental_backup_to_external_drive">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.7</span>Incremental backup to external drive</div>
			</a>
			
			<ul id="toc-Incremental_backup_to_external_drive-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Troubleshooting" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Troubleshooting">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7</span>Troubleshooting</div>
			</a>
			
				<button aria-controls="toc-Troubleshooting-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Troubleshooting subsection
				</button>
			
			<ul id="toc-Troubleshooting-sublist" class="sidebar-toc-list">
				<li id="toc-GRUB" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#GRUB">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.1</span>GRUB</div>
			</a>
			
			<ul id="toc-GRUB-sublist" class="sidebar-toc-list">
				<li id="toc-Partition_offset" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Partition_offset">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.1.1</span>Partition offset</div>
			</a>
			
			<ul id="toc-Partition_offset-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Missing_root" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Missing_root">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.1.2</span>Missing root</div>
			</a>
			
			<ul id="toc-Missing_root-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Mounting_timed_out" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Mounting_timed_out">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.2</span>Mounting timed out</div>
			</a>
			
			<ul id="toc-Mounting_timed_out-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-BTRFS:_open_ctree_failed" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#BTRFS:_open_ctree_failed">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.3</span>BTRFS: open_ctree failed</div>
			</a>
			
			<ul id="toc-BTRFS:_open_ctree_failed-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-btrfs_check" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#btrfs_check">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.4</span>btrfs check</div>
			</a>
			
			<ul id="toc-btrfs_check-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Constant_drive_activity" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Constant_drive_activity">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.5</span>Constant drive activity</div>
			</a>
			
			<ul id="toc-Constant_drive_activity-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-See_also" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#See_also">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">8</span>See also</div>
			</a>
			
			<ul id="toc-See_also-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
</nav>

			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<a id="top"></a>
				<nav class="vector-article-toolbar" aria-label="Tools" role="navigation">
					<div class="mw-article-toolbar-container">
						<div id="left-navigation">
							

<div id="p-associated-pages" class="vector-menu mw-portlet mw-portlet-associated-pages vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-nstab-main" class="selected mw-list-item"><a href="../en/Btrfs.html" title="View the content page [c]" accesskey="c"><span>Page</span></a></li>
<li id="ca-talk" class="mw-list-item"><a href="../en/Talk:Btrfs.html" rel="discussion" title="Discussion about the content page [t]" accesskey="t"><span>Discussion</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-label="Change language variant">
	<label id="p-variants-label" for="p-variants-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

						</div>
						<div id="right-navigation" class="vector-collapsible ">
							

<div id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-view" class="selected mw-list-item"><a href="../en/Btrfs.html"><span>Read</span></a></li>
<li id="ca-viewsource" class="mw-list-item"><a href="/index.php?title=Btrfs&amp;action=edit" title="This page is protected.
You can view its source [e]" accesskey="e"><span>View source</span></a></li>
<li id="ca-history" class="mw-list-item"><a href="/index.php?title=Btrfs&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown vector-has-collapsible-items" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox">
	<label id="p-cactions-label" for="p-cactions-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="../en/Btrfs.html"><span>Read</span></a></li>
<li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Btrfs&amp;action=edit"><span>View source</span></a></li>
<li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Btrfs&amp;action=history"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

						</div>
					</div>
				</nav>
				<div id="bodyContent" class="vector-body" data-mw-ve-target-container>
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        </div>

					    <div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p class="mw-no-invert">Related articles</p>
<ul>
<li><a href="../en/File_systems.html" title="File systems">File systems</a></li>
<li><a href="../en/Snapper.html" title="Snapper">Snapper</a></li>
<li><a href="../en/Yabsnap.html" title="Yabsnap">Yabsnap</a></li>
<li><a href="../en/Dm-crypt/Encrypting_an_entire_system.html#Btrfs_subvolumes_with_swap" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Btrfs subvolumes with swap</a></li>
</ul>
</div>
<p>From the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Introduction.html">Btrfs Documentation</a>:
</p>
<dl><dd>BTRFS is a modern copy on write (COW) filesystem for Linux aimed at implementing advanced features while also focusing on fault tolerance, repair and easy administration.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Like some other file systems, Btrfs is under continuous development. This means that specific features may not be ready for everyday use yet. To see if your use case might be affected, check the Btrfs Documentation’s <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Status.html">Status</a> and the <a href="#Known_issues">#Known issues</a> section of this article.</div>
<mw:tocplace></mw:tocplace>
<h2><span class="mw-headline" id="Preparation">Preparation</span></h2>
<p>For user space utilities, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package that is required for basic operations.
</p>
<p>If you need to boot from a Btrfs file system (i.e., your kernel and initramfs reside on a Btrfs partition), check if your <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a> supports Btrfs.
</p>
<h2><span class="mw-headline" id="File_system_creation">File system creation</span></h2>
<p>The following shows how to create a new Btrfs <a href="../en/File_systems.html" class="mw-redirect" title="File system">file system</a>. To convert an ext3/4 partition to Btrfs, see <a href="#Ext3/4_to_Btrfs_conversion">#Ext3/4 to Btrfs conversion</a>. To use a partitionless setup, see <a href="#Partitionless_Btrfs_disk">#Partitionless Btrfs disk</a>.
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span> for more information.
</p>
<h3><span class="mw-headline" id="File_system_on_a_single_device">File system on a single device</span></h3>
<p>To create a Btrfs filesystem on partition <code>/dev/<i>partition</i></code>:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> /dev/<i>partition</i>
</pre>
<p>The Btrfs default nodesize for metadata is 16 KiB, while the default sectorsize for data is equal to page size and autodetected. To use a larger nodesize for metadata (must be a multiple of sectorsize, up to 64 KiB is allowed), specify a value for the <code>nodesize</code> via the <code>-n</code> switch as shown in this example using 32 KiB blocks:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> -n 32k /dev/<i>partition</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> According to <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8#OPTIONS">mkfs.btrfs(8) § OPTIONS</a></span>, "[a] smaller node size increases fragmentation but leads to taller b-trees which in turn leads to lower locking contention. Higher node sizes give better packing and less fragmentation at the cost of more expensive memory operations while updating the metadata blocks".</div>
<h3><span class="mw-headline" id="Multi-device_file_system">Multi-device file system</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> The RAID 5 and RAID 6 modes of Btrfs are fatally flawed, and should not be used for "anything but testing with throw-away data." <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">List of known problems and partial workarounds</a>. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#RAID56_STATUS_AND_RECOMMENDED_PRACTICES">btrfs(5) § RAID56 STATUS AND RECOMMENDED PRACTICES</a></span> for status updates.</div>
<p>Multiple devices can be used to create a RAID. Supported RAID levels include RAID 0, RAID 1, RAID 10, RAID 5 and RAID 6. Starting from kernel 5.5 RAID1c3 and RAID1c4 for 3- and 4- copies of RAID 1 level. The RAID levels can be configured separately for data and metadata using the <code>-d</code> and <code>-m</code> options respectively. By default, the data has one copy (<code>single</code>) and the metadata is mirrored (<code>raid1</code>). This is similar to 
creating a <a href="https://en.wikipedia.org/wiki/JBOD" class="extiw" title="w:JBOD">JBOD configuration</a>, where disks are seen as one filesystem, but files are not duplicated. See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Using Btrfs with Multiple Devices</a> for more information about how to create a Btrfs RAID volume.
</p>
<pre># mkfs.btrfs -d single -m raid1 /dev/<i>part1</i> /dev/<i>part2</i> ...
</pre>
<p>You must include either the <code>udev</code> hook, <code>systemd</code> hook or the <code>btrfs</code> hook in <code>/etc/mkinitcpio.conf</code> in order to use multiple Btrfs devices in a pool. See the <a href="../en/Mkinitcpio.html#Common_hooks" title="Mkinitcpio">Mkinitcpio#Common hooks</a> article for more information.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>It is possible to add devices to a multiple-device filesystem later on. See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Btrfs wiki article</a> for more information.</li>
<li>Devices can be of different sizes. However, if one drive in a RAID configuration is bigger than the others, this extra space will not be used.</li>
<li>Some <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loaders</a> such as <a href="../en/Syslinux.html" title="Syslinux">Syslinux</a> do not support multi-device file systems.</li>
<li>Btrfs does not automatically read from the fastest device, so mixing different kinds of disks results in inconsistent performance. See <a rel="nofollow" class="external autonumber" href="https://stackoverflow.com/a/55408367">[1]</a> for details.</li>
</ul>
</div>
<p>See <a href="#RAID">#RAID</a> for advice on maintenance specific to multi-device Btrfs file systems.
</p>
<h2><span class="mw-headline" id="Configuring_the_file_system">Configuring the file system</span></h2>
<h3>
<span id="Copy-on-Write_.28CoW.29"></span><span class="mw-headline" id="Copy-on-Write_(CoW)">Copy-on-Write (CoW)</span>
</h3>
<p>By default, Btrfs uses <a href="https://en.wikipedia.org/wiki/copy-on-write" class="extiw" title="wikipedia:copy-on-write">copy-on-write</a> for all files all the time. Writes do not overwrite data in place; instead, a modified copy of the block is written to a new location, and metadata is updated to point at the new location. See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Copy_on_Write_.28CoW.29">Btrfs Sysadmin Guide section</a> for implementation details, as well as advantages and disadvantages.
</p>
<h4><span class="mw-headline" id="Disabling_CoW">Disabling CoW</span></h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Disabling CoW in Btrfs also disables checksums. Btrfs will not be able to detect corrupted <code>nodatacow</code> files. When combined with RAID 1, power outages or other sources of corruption can cause the data to become out of sync.</div>
<p>To disable copy-on-write for newly created files in a mounted subvolume, use the <code>nodatacow</code> mount option. This will only affect newly created files. Copy-on-write will still happen for existing files. The <code>nodatacow</code> option also disables compression. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span> for details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>:
<dl><dd>within a single file system, it is not possible to mount some subvolumes with <code>nodatacow</code> and others with <code>datacow</code>. The mount option of the first mounted subvolume applies to any other subvolumes.</dd></dl>
</div>
<p>To disable copy-on-write for single files/directories, do:
</p>
<pre>$ chattr +C <i>/dir/file</i>
</pre>
<p>This will disable copy-on-write for those operation in which there is only one reference to the file. If there is more than one reference, e.g. due to file clones / lightweight clones or filesystem snapshots, copy-on-write still occurs. Note that as of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=coreutils">coreutils</a></span> 9.0, <code>cp</code> attempts to perform lightweight copies by default — see <span class="plainlinks archwiki-template-man" title="$ man 1 cp"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cp.1">cp(1)</a></span> for more details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 1 chattr"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/chattr.1">chattr(1)</a></span>:
<dl><dd>For btrfs, the '<code>C</code>' flag should be set on new or empty files. If it is set on a file which already has data blocks, it is undefined when the blocks assigned to the file will be fully stable. If the '<code>C</code>' flag is set on a directory, it will have no effect on the directory, but new files created in that directory will have the <code>No_COW</code> attribute.</dd></dl>
</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In accordance with the note above, you can use the following trick to disable copy-on-write on existing files in a directory:
<pre>$ mv <i>/path/to/dir</i> <i>/path/to/dir</i>_old
$ mkdir <i>/path/to/dir</i>
$ chattr +C <i>/path/to/dir</i>
$ cp -a --reflink=never <i>/path/to/dir</i>_old/. <i>/path/to/dir</i>
$ rm -rf <i>/path/to/dir</i>_old
</pre>
Make sure that the data are not used during this process. Also note that <code>mv</code> or <code>cp</code> without <code>--reflink=never</code> as described below will not work.</div>
<h3><span class="mw-headline" id="Compression">Compression</span></h3>
<p>Btrfs supports <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Compression.html">transparent and automatic compression</a>. This reduces the size of files as well as significantly increases the lifespan of flash-based media by reducing write amplification. See <a href="https://fedoraproject.org/wiki/Changes/BtrfsByDefault#Compression" class="extiw" title="fedora:Changes/BtrfsByDefault">Fedora:Changes/BtrfsByDefault#Compression</a>, <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/message/NTV77NFF6NDZM3QTPUM2TQZ5PCM6GOO2/">[2]</a>, and <a rel="nofollow" class="external autonumber" href="https://pagure.io/fedora-btrfs/project/issue/36#comment-701551">[3]</a>. It can also <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs_compress_2635&amp;num=1">improve performance</a>, in some cases (e.g. single thread with heavy file I/O), while obviously harming performance in other cases (e.g. multi-threaded and/or CPU intensive tasks with large file I/O). Better performance is generally achieved with the fastest compress algorithms, <i>zstd</i> and <i>lzo</i>, and some <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs-zstd-compress">benchmarks</a> provide detailed comparisons.
</p>
<p>LZO has a fixed compression level, whereas ZLIB &amp; ZSTD have a range of levels from 1 (low compression) to 9 (ZLIB) or 15 (ZSTD); see <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#COMPRESSION">btrfs(5) § COMPRESSION</a></span>. Changing the levels will affect CPU and I/O throughput differently, so they should be checked / benchmarked before &amp; after changing.
</p>
<p>The <code>compress=<i>alg[:level]</i></code> mount option enables automatically considering every file for compression, where <code><i>alg</i></code> is either <code>zlib</code>, <code>lzo</code>, <code>zstd</code>, or <code>no</code> (for no compression). Using this option, btrfs will check if compressing the first portion of the data shrinks it.  If it does, the entire write to that file will be compressed.  If it does not, none of it is compressed.  With this option, if the first portion of the write does not shrink, no compression will be applied to the write even if the rest of the data would shrink tremendously. <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Compression.html#incompressible-data">[4]</a>  This is done to prevent making the disk wait to start writing until all of the data to be written is fully given to btrfs and compressed.
</p>
<p>The <code>compress-force=<i>alg[:level]</i></code> mount option can be used instead, which makes btrfs skip checking if compression shrinks the first portion, and enables automatic compression try for every file.  In a worst-case scenario, this can cause (slightly) more CPU usage for no purpose. However, empirical testing on multiple mixed-use systems showed a significant improvement of about 10% disk compression from using <code>compress-force=<i>zstd</i></code> over just <code>compress=<i>zstd</i></code>, which also had 10% disk compression.
</p>
<p>Only files created or modified after the mount option is added will be compressed.
</p>
<p>To apply compression to existing files, use the <code>btrfs filesystem defragment -c<i>alg</i></code> command, where <code><i>alg</i></code> is either <code>zlib</code>, <code>lzo</code> or <code>zstd</code>. For example, in order to re-compress the whole file system with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=zstd">zstd</a></span>, run the following command:
</p>
<pre># btrfs filesystem defragment -r -v -czstd /
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  Defragmenting a file which has a COW copy (either a snapshot copy or one made with <code>cp</code> or bcp) plus using the <code>-c</code> switch with a compression algorithm may result in two unrelated files effectively increasing the disk usage.</div>
<p>To enable compression when installing Arch to an empty Btrfs partition, use the <code>compress</code> option when <a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mounting">mounting</a> the file system: <code>mount -o compress=zstd /dev/sd<i>xY</i> /mnt/</code>. During configuration, add <code>compress=zstd</code> to the mount options of the root file system in <a href="../en/Fstab.html" title="Fstab">fstab</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Compression can also be enabled per-file without using the <code>compress</code> mount option; to do so, apply <code>chattr +c</code> to the file. When applied to directories, it will cause new files to be automatically compressed as they come.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>Systems using older kernels or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> without <code>zstd</code> support may be unable to read or repair your filesystem if you use this option.</li>
<li>
<a href="../en/GRUB.html" title="GRUB">GRUB</a> introduced <i>zstd</i> support in 2.04.  Make sure you have actually upgraded the bootloader installed in your MBR/ESP since then, by running <code>grub-install</code> with the appropriate options for your BIOS/UEFI setup, since that is not done automatically. See <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/63235">FS#63235</a>.</li>
</ul>
</div>
<h4><span class="mw-headline" id="View_compression_types_and_ratios">View compression types and ratios</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=compsize">compsize</a></span> takes a list of files (or an entire btrfs filesystem) and measures compression types used and effective compression ratios.  Uncompressed size may not match the number given by other programs such as <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span>, because every extent is counted once, even if it is reflinked several times, and even if a part of it is no longer used anywhere but has not been garbage collected.  The <code>-x</code> option keeps it on a single filesystem, which is useful in situations like <code>compsize -x /</code> to avoid it from attempting to look in non-btrfs subdirectories and fail the entire run.
</p>
<h3><span class="mw-headline" id="Subvolumes">Subvolumes</span></h3>
<p>"A btrfs subvolume is not a block device (and cannot be treated as one) instead, a btrfs subvolume can be thought of as a POSIX file namespace. This namespace can be accessed via the top-level subvolume of the filesystem, or it can be mounted in its own right." <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">[5]</a>
</p>
<p>Each Btrfs file system has a top-level subvolume with ID 5. It can be mounted as <code>/</code> (by default), or another subvolume can be <a href="#Mounting_subvolumes">mounted</a> instead. Subvolumes can be moved around in the filesystem and are rather identified by their id than their path.
</p>
<p>See the following links for more details:
</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Subvolumes.html">Btrfs Documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">Btrfs Wiki SysadminGuide#Subvolumes</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Trees.html">Btrfs Wiki Trees</a></li>
</ul>
<h4><span class="mw-headline" id="Creating_a_subvolume">Creating a subvolume</span></h4>
<p>To create a subvolume, the btrfs filesystem must be mounted. The subvolume's name is set using the last argument.
</p>
<pre># btrfs subvolume create <i>/path/to/subvolume</i>
</pre>
<h4><span class="mw-headline" id="Listing_subvolumes">Listing subvolumes</span></h4>
<p>To see a list of current subvolumes and their ids under <code><i>path</i></code>:
</p>
<pre># btrfs subvolume list -p <i>path</i>
</pre>
<h4><span class="mw-headline" id="Deleting_a_subvolume">Deleting a subvolume</span></h4>
<p>To delete a subvolume:
</p>
<pre># btrfs subvolume delete <i>/path/to/subvolume</i>
</pre>
<p>Alternatively, a subvolume can be deleted like a regular directory (<code>rm -r</code>, <code>rmdir</code>).
</p>
<h4><span class="mw-headline" id="Mounting_subvolumes">Mounting subvolumes</span></h4>
<p>Subvolumes can be mounted like file system partitions using the <code>subvol=<i>/path/to/subvolume</i></code> or <code>subvolid=<i>objectid</i></code> mount flags. For example, you could have a subvolume named <code>subvol_root</code> and mount it as <code>/</code>.  One can mimic traditional file system partitions by creating various subvolumes under the top level of the file system and then mounting them at the appropriate mount points. It is preferable to mount using <code>subvol=<i>/path/to/subvolume</i></code>, rather than the subvolid, as the subvolid may change when restoring <a href="#Snapshots">#Snapshots</a>, requiring a change of mount configuration.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Changing subvolume layouts is made simpler by not using the top-level subvolume (ID=5) as <code>/</code> (which is done by default). Instead, consider creating a subvolume to house your actual data and mounting it as <code>/</code>.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>:
<dl><dd>Most mount options apply to the <b>whole filesystem</b>, and only the options for the first subvolume to be mounted will take effect. This is due to lack of implementation and may change in the future.</dd></dl>
<p>See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Can_I_mount_subvolumes_with_different_mount_options.3F">Btrfs Wiki FAQ</a> for which mount options can be used per subvolume.
</p>
</div>
<p>See <a href="../en/Snapper.html#Suggested_filesystem_layout" title="Snapper">Snapper#Suggested filesystem layout</a>, <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Managing_Snapshots">Btrfs SysadminGuide#Managing Snapshots</a>, and <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Layout">SysadminGuide#Layout</a> for example file system layouts using subvolumes.
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span> for a full list of btrfs-specific mount options.
</p>
<h4><span class="mw-headline" id="Mounting_subvolume_as_root">Mounting subvolume as root</span></h4>
<p>To use a subvolume as the root mountpoint, either make it the <a href="#Changing_the_default_sub-volume">default subvolume</a>, or specify the subvolume via a <a href="../en/Kernel_parameters.html#Configuration" title="Kernel parameters">kernel parameter</a> using <code>rootflags=subvol=<i>/path/to/subvolume</i></code>. Edit the root mountpoint in <code>/etc/fstab</code> and specify the mount option <code>subvol=</code>. Alternatively, the subvolume can be specified with its id, <code>rootflags=subvolid=<i>objectid</i></code> as kernel parameter and <code>subvolid=<i>objectid</i></code> as mount option in <code>/etc/fstab</code>. It is preferable to mount using <code>subvol=<i>/path/to/subvolume</i></code>, rather than the subvolid, as the subvolid may change when restoring <a href="#Snapshots">#Snapshots</a>, requiring a change of mount configuration, or else the system will not boot.
</p>
<h4><span class="mw-headline" id="Changing_the_default_sub-volume">Changing the default sub-volume</span></h4>
<p>The default sub-volume is mounted if no <code>subvol=</code> mount option is provided. To change the default subvolume, do:
</p>
<pre># btrfs subvolume set-default <i>subvolume-id</i> /
</pre>
<p>where <i>subvolume-id</i> can be found by <a href="#Listing_subvolumes">listing</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> After changing the default subvolume on a system with <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you should run <code>grub-install</code> again to notify the bootloader of the changes. See <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1615373">this forum thread</a>.</div>
<p>Changing the default subvolume with <code>btrfs subvolume set-default</code> will make the top level of the filesystem inaccessible, except by use of the <code>subvol=/</code> or <code>subvolid=5</code> mount options <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Administration.html">[6]</a>.
</p>
<h3><span class="mw-headline" id="Quota">Quota</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Qgroup is not stable yet and combining quota with (too many) snapshots of subvolumes can cause performance problems, for example when deleting snapshots. Plus there are several more <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Quota_support.html#Known_issues">known issues</a>.</div>
<p>Quota support in Btrfs is implemented at a subvolume level by the use of quota groups or qgroup: Each subvolume is assigned a quota groups in the form of <i>0/subvolume_id</i> by default. However, it is possible to create a quota group using any number if desired.
</p>
<p>To use qgroups, you need to enable quota first using
</p>
<pre># btrfs quota enable <i>path</i>
</pre>
<p>From this point onwards, newly created subvolumes will be controlled by those groups.
In order to retrospectively enable them for already existing subvolumes, enable quota normally, then create a qgroup (quota group) for each of those subvolume using their <i>subvolume_id</i> and rescan them:
</p>
<pre># btrfs subvolume list <i>path</i> | cut -d' ' -f2 | xargs -I{} -n1 btrfs qgroup create 0/{} <i>path</i>
# btrfs quota rescan <i>path</i>
</pre>
<p>Quota groups in Btrfs form a tree hierarchy, whereby qgroups are attached to subvolumes. The size limits are set per qgroup and apply when any limit is reached in tree that contains a given subvolume.
</p>
<p>Limits on quota groups can be applied either to the total data usage, un-shared data usage, compressed data usage or both. File copy and file deletion may both affect limits since the unshared limit of another qgroup can change if the original volume's files are deleted and only one copy is remaining. For example, a fresh snapshot shares almost all the blocks with the original subvolume, new writes to either subvolume will raise towards the exclusive limit, deletions of common data in one volume raises towards the exclusive limit in the other one.
</p>
<p>To apply a limit to a qgroup, use the command <code>btrfs qgroup limit</code>. Depending on your usage, either use a total limit, unshared limit (<code>-e</code>) or compressed limit (<code>-c</code>).
To show usage and limits for a given path within a filesystem, use
</p>
<pre># btrfs qgroup show -reF <i>path</i>
</pre>
<h3><span class="mw-headline" id="Commit_interval">Commit interval</span></h3>
<p>The resolution at which data are written to the filesystem is dictated by Btrfs itself and by system-wide settings. Btrfs defaults to a 30 seconds checkpoint interval in which new data are committed to the filesystem. This can be changed by appending the <code>commit</code> mount option in <code>/etc/fstab</code> for the btrfs partition.
</p>
<pre>LABEL=arch64 / btrfs defaults,compress=zstd,commit=120 0 0
</pre>
<p>System-wide settings also affect commit intervals. They include the files under <code>/proc/sys/vm/*</code> and are out-of-scope of this wiki article. The kernel documentation for them is available at <a rel="nofollow" class="external free" href="https://docs.kernel.org/admin-guide/sysctl/vm.html">https://docs.kernel.org/admin-guide/sysctl/vm.html</a>.
</p>
<h3><span class="mw-headline" id="SSD_TRIM">SSD TRIM</span></h3>
<p>A Btrfs filesystem is able to free unused blocks from an SSD drive supporting the TRIM command. Asynchronous discard support is available with mount option <code>discard=async</code>, and is enabled by default as of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> 6.2. Freed extents are not discarded immediately, but grouped together and trimmed later by a separate worker thread, improving commit latency. 
</p>
<p>Asynchronous discard can safely be used alongside periodic trim <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/thread/MLZIPQUXMJFRVSFJS6B2ACDKTYNSX3AX/">[7]</a>.
</p>
<p>More information about enabling and using TRIM can be found in <a href="../en/Solid_state_drive.html#TRIM" class="mw-redirect" title="Solid State Drives">Solid State Drives#TRIM</a>.
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<h3><span class="mw-headline" id="Swap_file">Swap file</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Swap files on file systems spanning multiple devices are not supported. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span> for all limitations.
</div>
<p>To properly initialize a swap file, first create a <i>non-snapshotted</i> subvolume to host the file, e.g. 
</p>
<pre># btrfs subvolume create /swap 
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Consider creating the subvolume directly below the top-level subvolume, e.g. <code>@swap</code>. Then, make sure the subvolume is <a href="#Mounting_subvolumes">mounted</a> to <code>/swap</code> (or any other accessible location).</div>
<p>Create the swap file:
</p>
<pre># btrfs filesystem mkswapfile --size 4g --uuid clear /swap/swapfile
</pre>
<p>If <code>--size</code> is omitted, the default of 2GiB is used.
</p>
<p>Activate the swap file:
</p>
<pre># swapon /swap/swapfile
</pre>
<p>Finally, edit the <a href="../en/Fstab.html" title="Fstab">fstab</a> configuration to add an entry for the swap file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/swap/swapfile none swap defaults 0 0
</pre>
<p>For additional information, see <a href="../en/Fstab.html#Usage" title="Fstab">fstab#Usage</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You can also create the swap file manually, by <a href="#Disabling_CoW">setting the</a> <code>No_COW</code> attribute on the whole subvolume with <code>chattr</code>, then following the steps in <a href="../en/Swap.html#Swap_file_creation" title="Swap">Swap#Swap file creation</a>. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span> for an alternative method.</div>
<p>Configuring hibernation to a swap file is described in <a href="../en/Power_management/Suspend_and_hibernate.html#Hibernation_into_swap_file" title="Power management/Suspend and hibernate">Power management/Suspend and hibernate#Hibernation into swap file</a>.
</p>
<h3>
<span id="Displaying_used.2Ffree_space"></span><span class="mw-headline" id="Displaying_used/free_space">Displaying used/free space</span>
</h3>
<p>General linux userspace tools such as <span class="plainlinks archwiki-template-man" title="$ man 1 df"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/df.1">df(1)</a></span> will inaccurately report free space on a Btrfs partition. It is recommended to use <code>btrfs filesystem usage</code> to query Btrfs partitions. For example, for a full breakdown of device allocation and usage stats:
</p>
<pre># btrfs filesystem usage /
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>btrfs filesystem usage</code> command does not currently work correctly with <code>RAID5/RAID6</code> RAID levels.</div>
<p>Alternatively, <code>btrfs filesystem df</code> allows a quick check on usage of allocated space without the requirement to run as root:
</p>
<pre>$ btrfs filesystem df /
</pre>
<p>See <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#How_much_free_space_do_I_have.3F">[8]</a> for more information.
</p>
<p>The same limitations apply to tools which analyze space usage for some subset of the filesystem, such as <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span> or <span class="plainlinks archwiki-template-man" title="$ man 1 ncdu"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ncdu.1">ncdu(1)</a></span>, as they do not take into account reflinks, snapshots and compression. Instead, see <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/btdu/">btdu</a></span><sup><small>AUR</small></sup> and <a href="#View_compression_types_and_ratios">compsize</a> for btrfs-aware alternatives.
</p>
<h3><span class="mw-headline" id="Defragmentation">Defragmentation</span></h3>
<p>Btrfs supports online defragmentation through the mount option <code>autodefrag</code>; see <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>. To manually defragment your root, use:
</p>
<pre># btrfs filesystem defragment -r /
</pre>
<p>Using the above command without the <code>-r</code> switch will result in only the metadata held by the subvolume containing the directory being defragmented. This allows for single file defragmentation by simply specifying the path.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Defragmenting a file which has a COW copy (either a snapshot copy or one made with <code>cp</code> or bcp) plus using the <code>-c</code> switch with a compression algorithm may result in two unrelated files effectively increasing the disk usage.</div>
<h3><span class="mw-headline" id="RAID">RAID</span></h3>
<p>Btrfs offers native "RAID" for <a href="#Multi-device_file_system">#Multi-device file systems</a>. Notable features which set btrfs RAID apart from <a href="../en/RAID.html" class="mw-redirect" title="Mdadm">mdadm</a> are self-healing redundant arrays and online balancing. See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">the Btrfs wiki page</a> for more information. The Btrfs sysadmin page also <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#RAID_and_data_replication">has a section</a> with some more technical background.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Parity RAID (RAID 5/6) code has multiple serious data-loss bugs in it. See the Btrfs Wiki's <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/btrfs-man5.html#raid56-status-and-recommended-practices">RAID5/6 page</a> and a bug report on <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/8695beeb-f991-28c4-cf6b-8c92339e468f@inwind.it/">linux-btrfs mailing list</a> for more detailed information. In June 2020, somebody posted a <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627030614.GW10769@hungrycats.org/">comprehensive list of current issues</a> and a <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">helpful recovery guide</a>. </div>
<h4><span class="mw-headline" id="Scrub">Scrub</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/questions/556816/does-btrfs-scrub-examine-subvolume-or-the-device-that-subvolume-resides-on">Does Btrfs scrub examine subvolume or the device that subvolume resides on?</a> (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Btrfs">Talk:Btrfs</a>)</div>
</div>
<p>The <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">Btrfs Wiki Glossary</a> says that Btrfs scrub is "[a]n online filesystem checking tool. Reads all the data and metadata on the filesystem and uses checksums and the duplicate copies from RAID storage to identify and repair any corrupt data."
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> A running scrub process will prevent the system from suspending, see <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20140227190656.GA28338@merlins.org/">this thread</a> for details.</div>
<h5><span class="mw-headline" id="Start_manually">Start manually</span></h5>
<p>To start a (background) scrub on the filesystem which contains <code>/</code>:
</p>
<pre># btrfs scrub start /
</pre>
<p>To check the status of a running scrub:
</p>
<pre># btrfs scrub status /
</pre>
<h5><span class="mw-headline" id="Start_with_a_service_or_timer">Start with a service or timer</span></h5>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package brings the <code>btrfs-scrub@.timer</code> unit for monthly scrubbing the specified mountpoint. <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> the timer with an escaped path, e.g. <code>btrfs-scrub@-.timer</code> for <code>/</code> and <code>btrfs-scrub@home.timer</code> for <code>/home</code>. You can use <code>systemd-escape -p <i>/path/to/mountpoint</i></code> to escape the path; see <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-escape"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-escape.1">systemd-escape(1)</a></span> for details.
</p>
<p>You can also run the scrub by <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Starting">starting</a> <code>btrfs-scrub@.service</code> (with the same encoded path). The advantage of this over <code>btrfs scrub</code> (as the root user) is that the results of the scrub will be logged in the <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Systemd journal">systemd journal</a>.
</p>
<p>On large NVMe drives with insufficient cooling (e.g. in a laptop), scrubbing can read the drive fast enough and long enough to get it very hot. If you are running scrubs with systemd, you can easily limit the rate of scrubbing with the <code>IOReadBandwidthMax</code> option described in <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.resource-control"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.resource-control.5">systemd.resource-control(5)</a></span> by using a <a href="../en/Systemd.html#Drop-in_files" class="mw-redirect" title="Drop-in file">drop-in file</a>.
</p>
<h4><span class="mw-headline" id="Balance">Balance</span></h4>
<p>"A balance passes all data in the filesystem through the allocator again. It is primarily intended to rebalance the data in the filesystem across the devices when a device is added or removed. A balance will regenerate missing copies for the redundant RAID levels, if a device has failed." <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">[9]</a> See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#What_does_.22balance.22_do.3F">Upstream FAQ page</a>.
</p>
<p>On a single-device filesystem, a balance may be also useful for (temporarily) reducing the amount of allocated but unused (meta)data chunks. Sometimes this is needed for fixing <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Help.21_Btrfs_claims_I.27m_out_of_space.2C_but_it_looks_like_I_should_have_lots_left.21">"filesystem full" issues</a>.
</p>
<pre># btrfs balance start --bg /
# btrfs balance status /
</pre>
<h3><span class="mw-headline" id="Snapshots">Snapshots</span></h3>
<p>"A snapshot is simply a subvolume that shares its data (and metadata) with some other subvolume, using btrfs's COW capabilities." See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Snapshots">Btrfs Wiki SysadminGuide#Snapshots</a> for details.
</p>
<p>To create a snapshot:
</p>
<pre># btrfs subvolume snapshot <i>source</i> [<i>dest</i>/]<i>name</i>
</pre>
<p>To create a readonly snapshot, add the <code>-r</code> flag. To create a writable version of a readonly snapshot, simply create a snapshot of it.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>It is possible for a snapshot to be converted in-place from readonly to writeable. However, this is not recommended because it <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/06e92a0b-e71b-eb21-edb5-9d2a5513b718@gmail.com/">causes issues</a> with any future incremental send/receive. Making a new writeable snapshot prevents such issues.</li>
<li>Snapshots are not recursive. Every nested subvolume will be an empty directory inside the snapshot.</li>
</ul>
</div>
<h3>
<span id="Send.2Freceive"></span><span class="mw-headline" id="Send/receive">Send/receive</span>
</h3>
<p>A subvolume can be sent to stdout or a file using the <code>send</code> command. This is usually most useful when piped to a Btrfs <code>receive</code> command. For example, to send a snapshot named <code>/root_backup</code> (perhaps of a snapshot you made of <code>/</code> earlier) to <code>/backup</code>, you would do the following:
</p>
<pre># btrfs send /root_backup | btrfs receive /backup
</pre>
<p>The snapshot that is sent <i>must</i> be readonly. The above command is useful for copying a subvolume to an external device (e.g. a USB disk mounted at <code>/backup</code> above).
</p>
<p>You can also send only the difference between two snapshots. For example, if you have already sent a copy of <code>root_backup</code> above and have made a new readonly snapshot on your system named <code>root_backup_new</code>, then to send only the incremental difference to <code>/backup</code>, do:
</p>
<pre># btrfs send -p /root_backup /root_backup_new | btrfs receive /backup
</pre>
<p>Now, a new subvolume named <code>root_backup_new</code> will be present in <code>/backup</code>.
</p>
<p>See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Incremental_Backup.html">Btrfs Wiki's Incremental Backup page</a> and <a href="#Incremental_backup_to_external_drive">#Incremental backup to external drive</a> on how to use this for incremental backups and for tools that automate the process.
</p>
<h3><span class="mw-headline" id="Deduplication">Deduplication</span></h3>
<p>Using copy-on-write, Btrfs is able to copy files or whole subvolumes without actually copying the data. However, whenever a file is altered, a new <i>proper</i> copy is created. Deduplication takes this a step further by actively identifying blocks of data which share common sequences and combining them into an extent with the same copy-on-write semantics.
</p>
<p>Tools dedicated to deduplicate a Btrfs formatted partition include <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=duperemove">duperemove</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bees">bees</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bedup/">bedup</a></span><sup><small>AUR</small></sup> and <i>btrfs-dedup</i>. One may also want to merely deduplicate data on a file based level instead using e.g. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rmlint">rmlint</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/jdupes/">jdupes</a></span><sup><small>AUR</small></sup> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/dduper-git/">dduper-git</a></span><sup><small>AUR</small></sup>. For an overview of available features of those programs and additional information, have a look at the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Deduplication.html">upstream Wiki entry</a>.
</p>
<p>Furthermore, Btrfs developers are working on inband (also known as synchronous or inline) deduplication, meaning deduplication done when writing new data to the filesystem. Currently, it is still an experiment which is developed out-of-tree. Users willing to test the new feature should read the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/User_notes_on_dedupe.html">appropriate kernel wiki page</a>.
</p>
<h3><span class="mw-headline" id="Resizing">Resizing</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> To avoid data loss, ensure that you back up your data before you begin any resizing task.</div>
<p>You can grow a file system to the maximum space available on the device, or specify an exact size. Ensure that you grow the size of the device or logical volume before you attempt to increase the size of the file system.
When specifying an exact size for the file system on a device, either increasing or decreasing, ensure that the new size satisfies the following conditions:
</p>
<ul>
<li>The new size must be greater than the size of the existing data; otherwise, data loss occurs.</li>
<li>The new size must be equal to or less than the current device size because the file system size cannot extend beyond the space available.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you plan to also decrease the size of the logical volume that holds the file system, ensure that you decrease the size of the file system before you attempt to decrease the size of the device or logical volume.</div>
<p>To extend the file system size to the maximum available size of the device:
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>To extend the file system to a specific size:
</p>
<pre># btrfs filesystem resize <i>size</i> /
</pre>
<p>Replace <code><i>size</i></code> with the desired size in bytes. You can also specify units on the value, such as K (kibibytes), M (mebibytes), or G (gibibytes). Alternatively, you can specify an increase or decrease to the current size by prefixing the value with a plus (+) or a minus (-) sign, respectively:
</p>
<pre># btrfs filesystem resize +<i>size</i> /
# btrfs filesystem resize -<i>size</i> /
</pre>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<p>A few limitations should be known before trying.
</p>
<h3><span class="mw-headline" id="Encryption">Encryption</span></h3>
<p>Btrfs has no built-in encryption support, but this <a rel="nofollow" class="external text" href="https://lwn.net/Articles/700487/">may</a> come in the future. Users can encrypt the partition before running <code>mkfs.btrfs</code>. See <a href="../en/Dm-crypt/Encrypting_an_entire_system.html#Btrfs_subvolumes_with_swap" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Btrfs subvolumes with swap</a>. 
</p>
<p>Existing Btrfs file systems can use something like <a href="../en/EncFS.html" title="EncFS">EncFS</a> or <a href="../en/VeraCrypt.html" class="mw-redirect" title="TrueCrypt">TrueCrypt</a>, though perhaps without some of Btrfs' features.
</p>
<h3><span class="mw-headline" id="btrfs_check_issues">btrfs check issues</span></h3>
<p>The tool <code>btrfs check</code> has known issues and should not be run without further reading; see section <a href="#btrfs_check">#btrfs check</a>.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Partitionless_Btrfs_disk">Partitionless Btrfs disk</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Most users do not want this type of setup and instead should install Btrfs on a regular partition. Furthermore, GRUB strongly discourages installation to a partitionless disk.</div>
<p>Btrfs can occupy an entire data storage device, replacing the <a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="MBR">MBR</a> or <a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GPT">GPT</a> partitioning schemes, using <a href="#Subvolumes">subvolumes</a> to simulate partitions. However, using a partitionless setup is not required to simply <a href="#File_system_creation">create a Btrfs filesystem</a> on an existing <a href="../en/Partitioning.html" class="mw-redirect" title="Partition">partition</a> that was created using another method. There are some limitations to partitionless single disk setups:
</p>
<ul>
<li>Cannot place other <a href="../en/File_systems.html" title="File systems">file systems</a> on another partition on the same disk.</li>
<li>Due to the previous point, having an <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> on this disk is not possible. Another device is necessary for <a href="../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a> boot.</li>
</ul>
<p>To overwrite the existing partition table with Btrfs, run the following command:
</p>
<pre># mkfs.btrfs /dev/sd<i>X</i>
</pre>
<p>For example, use <code>/dev/sda</code> rather than <code>/dev/sda1</code>. The latter would format an existing partition instead of replacing the entire partitioning scheme. Because the root partition is Btrfs, make sure <code>btrfs</code> is compiled into the kernel, or put <code>btrfs</code> into <a href="../en/Mkinitcpio.html#MODULES" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf#MODULES</a> and <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<p>Install the <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a> like you would for a data storage device with a <a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a>. See <a href="../en/Syslinux.html#Manual_install" title="Syslinux">Syslinux#Manual install</a> or  <a href="../en/GRUB/Tips_and_tricks.html#Install_to_partition_or_partitionless_disk" title="GRUB/Tips and tricks">GRUB/Tips and tricks#Install to partition or partitionless disk</a>. If your kernel does not boot due to <code>Failed to mount /sysroot.</code>, please add <code>GRUB_PRELOAD_MODULES="btrfs"</code> in <code>/etc/default/grub</code> and <a href="../en/GRUB.html#Generate_the_main_configuration_file" title="GRUB">generate</a> the grub configuration.
</p>
<h3>
<span id="Ext3.2F4_to_Btrfs_conversion"></span><span class="mw-headline" id="Ext3/4_to_Btrfs_conversion">Ext3/4 to Btrfs conversion</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> There are many reports on the btrfs mailing list about incomplete/corrupt/broken conversions. Make sure you have <i>working</i> backups of any data you cannot afford to lose. See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Conversion_from_Ext3.html">Conversion from Ext3</a> on the btrfs wiki for more information.
</div>
<p>Boot from an install CD, then convert by doing:
</p>
<pre># btrfs-convert /dev/<i>partition</i>
</pre>
<p>Mount the partion and test the conversion by checking the files.  Be sure to change the <code>/etc/fstab</code> to reflect the change (<b>type</b> to <code>btrfs</code> and <b>fs_passno</b> [the last field] to <code>0</code> as Btrfs does not do a file system check on boot). Also note that the UUID of the partition will have changed, so update fstab accordingly when using UUIDs. <code>chroot</code> into the system and rebuild your bootloaders menu list (see <a href="../en/Install_Arch_Linux_from_existing_Linux.html" class="mw-redirect" title="Install from existing Linux">Install from existing Linux</a>). If converting a root filesystem, while still chrooted, run <code>mkinitcpio -p linux</code> to regenerate the initramfs or the system will not successfully boot.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  If there is anything wrong, either unable to mount or write files to the newly converted btrfs; there is always the option to rollback as long as the backup subvolume <code>/ext2_saved</code> is still there. Use the <code>btrfs-convert -r /dev/<i>partition</i></code> command to rollback; this will discard any modifications to the newly converted btrfs filesystem.</div>
<p>After confirming that there are no problems, complete the conversion by deleting the backup <code>ext2_saved</code> sub-volume. Note that you cannot revert back to ext3/4 without it.
</p>
<pre># btrfs subvolume delete /ext2_saved
</pre>
<p>Finally, <a href="#Balance">balance</a> the file system to reclaim the space.
</p>
<p>Remember that some applications which were installed prior have to be adapted to Btrfs.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  Ext3/4 to Btrfs conversion is a time consuming operation. For a 4TB filesystem and a regular HDD, it can take up to 10 hours.</div>
<h3><span class="mw-headline" id="Corruption_recovery">Corruption recovery</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> The tool <code>btrfs check</code> has known issues, see section <a href="#btrfs_check">#btrfs check</a>
</div>
<p><i>btrfs-check</i> cannot be used on a mounted file system. To be able to use <i>btrfs-check</i> without booting from a live USB, add it to the initial ramdisk:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">BINARIES=(btrfs)</pre>
<p><a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.
</p>
<p>Then if there is a problem booting, the utility is available for repair.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If the fsck process has to invalidate the space cache (and/or other caches?), it is normal for a subsequent boot to hang up for a while (it may give console messages about btrfs-transaction being hung). The system should recover from this after a while.</div>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> for more information.
</p>
<h3><span class="mw-headline" id="Booting_into_snapshots">Booting into snapshots</span></h3>
<p>In order to boot into a snapshot, the same procedure applies as for mounting a subvolume as your root partition, as given in section <a href="#Mounting_subvolume_as_root">mounting a subvolume as your root partition</a>, because snapshots can be mounted like subvolumes.
</p>
<ul>
<li>If using <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you can automatically populate your boot menu with btrfs snapshots when regenerating the configuration file with the help of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub-btrfs">grub-btrfs</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/grub-btrfs-git/">grub-btrfs-git</a></span><sup><small>AUR</small></sup>.</li>
<li>If using <a href="../en/REFInd.html" title="REFInd">rEFInd</a>, you can automatically populate your boot menu with btrfs snapshots with the help of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/refind-btrfs/">refind-btrfs</a></span><sup><small>AUR</small></sup>, after <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enabling">enabling</a> <code>refind-btrfs.service</code>.</li>
</ul>
<h3><span class="mw-headline" id="Use_Btrfs_subvolumes_with_systemd-nspawn">Use Btrfs subvolumes with systemd-nspawn</span></h3>
<p>See the <a href="../en/Systemd-nspawn.html#Use_Btrfs_subvolume_as_container_root" title="Systemd-nspawn">Systemd-nspawn#Use Btrfs subvolume as container root</a> and <a href="../en/Systemd-nspawn.html#Use_temporary_Btrfs_snapshot_of_container" title="Systemd-nspawn">Systemd-nspawn#Use temporary Btrfs snapshot of container</a> articles.
</p>
<h3><span class="mw-headline" id="Reducing_access_time_metadata_updates">Reducing access time metadata updates</span></h3>
<p>Because of the copy-on-write nature of Btrfs, simply accessing files can trigger the metadata copy and writing. Reducing the frequency of access time updates may eliminate this unexpected disk usage and increase performance. See <a href="../en/Fstab.html#atime_options" title="Fstab">fstab#atime options</a> for the available options.
</p>
<h3><span class="mw-headline" id="Incremental_backup_to_external_drive">Incremental backup to external drive</span></h3>
<p>The following packages use <code>btrfs send</code> and <code>btrfs receive</code> to send backups incrementally to an external drive. Refer to their documentation to see differences in implementation, features, and requirements.
</p>
<ul><li>
<b>btrbk</b> — Tool for creating snapshots and remote backups of Btrfs subvolumes.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/digint/btrbk">https://github.com/digint/btrbk</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrbk">btrbk</a></span>
</dd></dl>
<ul><li>
<b>buttersink</b> — Buttersink is like rsync for Btrfs snapshots. Needs Python 2.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/AmesCornish/buttersink">https://github.com/AmesCornish/buttersink</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/buttersink-git/">buttersink-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>snap-sync</b> — Use <a href="../en/Snapper.html" title="Snapper">Snapper</a> snapshots to backup to external drive or remote machine.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/wesbarnett/snap-sync">https://github.com/wesbarnett/snap-sync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-sync">snap-sync</a></span>
</dd></dl>
<ul><li>
<b>snapsync</b> — A synchronization tool for <a href="../en/Snapper.html" title="Snapper">Snapper</a>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/doudou/snapsync">https://github.com/doudou/snapsync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/ruby-snapsync/">ruby-snapsync</a></span><sup><small>AUR</small></sup>
</dd></dl>
<p>The following package allows backing up snapper snapshots to non-Btrfs file systems.
</p>
<ul><li>
<b>snapborg</b> — borgmatic-like tool which integrates snapper snapshots with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=borg">borg</a></span> backups.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/enzingerm/snapborg">https://github.com/enzingerm/snapborg</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snapborg/">snapborg</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<p>See the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/trouble-index.html">Btrfs Troubleshooting pages</a> and <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Problem_FAQ.html">Btrfs Problem FAQ</a> for general troubleshooting.
</p>
<h3><span class="mw-headline" id="GRUB">GRUB</span></h3>
<h4><span class="mw-headline" id="Partition_offset">Partition offset</span></h4>
<p>The offset problem may happen when you try to embed <code>core.img</code> into a partitioned disk. It means that <a href="../Special:Diff/319474.html" title="Special:Diff/319474">it is OK</a> to embed GRUB's <code>core.img</code> into a Btrfs pool on a partitionless disk (e.g. <code>/dev/sd<i>X</i></code>) directly.
</p>
<p><a href="../en/GRUB.html" title="GRUB">GRUB</a> can boot Btrfs partitions, however the module may be larger than other <a href="../en/File_systems.html" title="File systems">file systems</a>. And the <code>core.img</code> file made by <code>grub-install</code> may not fit in the first 63 sectors (31.5KiB) of the drive between the MBR and the first partition. Up-to-date partitioning tools such as <code>fdisk</code> and <code>gdisk</code> avoid this issue by offsetting the first partition by roughly 1MiB or 2MiB.
</p>
<h4><span class="mw-headline" id="Missing_root">Missing root</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Suggests editing a non-configuration file manually. (Discuss in <a href="../en/Talk:Btrfs.html#Should_not_suggest_to_edit_files_in_/usr/share" title="Talk:Btrfs">Talk:Btrfs#Should not suggest to edit files in /usr/share</a>)</div>
</div>
<p>Users experiencing the following: <code>error no such device: root</code> when booting from a RAID style setup then edit /usr/share/grub/grub-mkconfig_lib and remove both quotes from the line <code>echo "  search --no-floppy --fs-uuid --set=root ${hints} ${fs_uuid}"</code>. Regenerate the config for grub and the system should boot without an error.
</p>
<h3><span class="mw-headline" id="Mounting_timed_out">Mounting timed out</span></h3>
<p>Sometimes, especially with large RAID1 arrays, mounting might time out during boot with a journal message such as:
</p>
<pre>Jan 25 18:05:12 host systemd[1]: storage.mount: Mounting timed out. Terminating.
Jan 25 18:05:46 host systemd[1]: storage.mount: Mount process exited, code=killed, status=15/TERM
Jan 25 18:05:46 host systemd[1]: storage.mount: Failed with result 'timeout'.
Jan 25 18:05:46 host systemd[1]: Failed to mount /storage.
Jan 25 18:05:46 host systemd[1]: Startup finished in 32.943s (firmware) + 3.097s (loader) + 7.247s (kernel)&gt;
Jan 25 18:05:46 host kernel: BTRFS error (device sda): open_ctree failed</pre>
<p>This can easily be worked around by providing a longer timeout via the systemd-specific mount option <code>x-systemd.mount-timeout</code> in <a href="../en/Fstab.html" title="Fstab">fstab</a>. For example:
</p>
<pre>/dev/sda                /storage    btrfs       rw,relatime,x-systemd.mount-timeout=5min  0 0
</pre>
<h3><span class="mw-headline" id="BTRFS:_open_ctree_failed">BTRFS: open_ctree failed</span></h3>
<p>As of November 2014, there seems to be a bug in <a href="../en/Systemd.html" title="Systemd">systemd</a> or <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> causing the following error on systems with multi-device Btrfs filesystem using the <code>btrfs</code> hook in <code>mkinitcpio.conf</code>:
</p>
<pre>BTRFS: open_ctree failed
mount: wrong fs type, bad option, bad superblock on /dev/sdb2, missing codepage or helper program, or other error

In some cases, useful info is found in syslog - try dmesg|tail or so.

You are now being dropped into an emergency shell.
</pre>
<p>A workaround is to remove <code>btrfs</code> from the <code>HOOKS</code> array in <code>/etc/mkinitcpio.conf</code> and instead add <code>btrfs</code> to the <code>MODULES</code> array. Then <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a> and reboot.
</p>
<p>You will get the same error if you try to mount a raid array without one of the devices. In that case, you must add the <code>degraded</code> mount option to <code>/etc/fstab</code>. If your root resides on the array, you must also add <code>rootflags=degraded</code> to your <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.
</p>
<p>As of August 2016, a potential workaround for this bug is to mount the array by a single drive only in <code>/etc/fstab</code>, and allow btrfs to discover and append the other drives automatically. Group-based identifiers such as UUID and LABEL appear to contribute to the failure. For example, a two-device RAID1 array consisting of 'disk1' and disk2' will have a UUID allocated to it, but instead of using the UUID, use only <code>/dev/mapper/disk1</code> in <code>/etc/fstab</code>. For a more detailed explanation, see the following <a rel="nofollow" class="external text" href="https://web.archive.org/web/20161108175034/http://blog.samcater.com/fix-for-btrfs-open_ctree-failed-when-running-root-fs-on-raid-1-or-raid10-arch-linux/">blog post</a>.
</p>
<p>Another possible workaround is to remove the <code>udev</code> hook in <a href="../en/Mkinitcpio.html#Configuration" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf</a> and replace it with the <code>systemd</code> hook. In this case, <code>btrfs</code> should <i>not</i> be in the <code>HOOKS</code> or <code>MODULES</code> arrays.
</p>
<p>See the <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=189845">original forums thread</a> and <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42884">FS#42884</a> for further information and discussion.
</p>
<h3><span class="mw-headline" id="btrfs_check">btrfs check</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Since Btrfs is under heavy development, especially the <code>btrfs check</code> command, it is highly recommended to create a <a href="../en/System_maintenance.html#Backup" class="mw-redirect" title="Backup">backup</a> and consult <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> before executing <code>btrfs check</code> with the <code>--repair</code> switch.</div>
<p>The <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> command can be used to check or repair an unmounted Btrfs filesystem. However, this repair tool is still immature and not able to repair certain filesystem errors even those that do not render the filesystem unmountable.
</p>
<h3><span class="mw-headline" id="Constant_drive_activity">Constant drive activity</span></h3>
<p>Since the <a href="../en/Kernel.html" title="Kernel">kernel</a> version 6.2, <code>discard=async</code> <span class="plainlinks archwiki-template-man" title="$ man 8 mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.8">mount(8)</a></span> option is set by default. This <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/Y%2F%2Bn1wS%2F4XAH7X1p@nz/#r">has been reported</a> to cause constant drive activity on some drives even while idle, as the discard queue is filled faster than it is processed. This can cause increased power usage, especially on NVMe-based drives.
</p>
<p>One workaround may be to increasing the discard <code>iops_limit</code> until drive activity stops.
</p>
<p>This can be accomplished using <a href="https://en.wikipedia.org/wiki/sysfs" class="extiw" title="wikipedia:sysfs">sysfs</a>, e.g.
</p>
<pre># echo 1000 &gt; /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit
</pre>
<p>Where <code><i>uuid</i></code> is the UUID of the btrfs filesystem. The limit of <code>1000</code> will need to be tuned experimentally.
</p>
<p>To set the parameter on boot, <a href="../en/Systemd.html#systemd-tmpfiles_-_temporary_files" class="mw-redirect" title="Systemd-tmpfiles">systemd-tmpfiles</a> may be used, e.g. by creating the following file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/btrfs-discard.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">w /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit - - - - 1000
</pre>
<p>Alternatively, one can disable asynchronous discard altogether by mounting using the <code>nodiscard</code> mount option in <a href="../en/Fstab.html" title="Fstab">fstab</a>, and instead use <a href="../en/Solid_state_drive.html#Periodic_TRIM" title="Solid state drive">Periodic TRIM</a>.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li>
<b>Official site</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io">Btrfs Documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/">Archived Btrfs Wiki</a></li>
</ul>
</li>
<li>
<b>Performance related</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://superuser.com/questions/432188/should-i-put-my-multi-device-btrfs-filesystem-on-disk-partitions-or-raw-devices">Btrfs on raw disks?</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/CAKcLGm_MKEdTiHFBd-b-v2sN5gJmgFRqsykzWRXTVqUw4O6Acw@mail.gmail.com/">Varying leafsize and nodesize in Btrfs</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/jgui4j$th5$1@dough.gmane.org/">Btrfs support for efficient SSD operation (data blocks alignment)</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Is_Btrfs_optimized_for_SSD.3F">Is Btrfs optimized for SSDs?</a></li>
<li><a rel="nofollow" class="external text" href="https://blog.erdemagaoglu.com/post/4605524309/lzo-vs-snappy-vs-lzf-vs-zlib-a-comparison-of">Lzo vs. zLib</a></li>
</ul>
</li>
<li>
<b>Miscellaneous</b>
<ul>
<li><a href="https://www.funtoo.org/BTRFS_Fun" class="extiw" title="funtoo:BTRFS Fun">Funtoo:BTRFS Fun</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA0ODU">Avi Miller presenting Btrfs</a> at SCALE 10x, January 2012.</li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA4Mzc">Summary of Chris Mason's talk</a> from LFCS 2012</li>
<li>
<a rel="nofollow" class="external text" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35054394c4b3cecd52577c2662c84da1f3e73525">Btrfs: stop providing a bmap operation to avoid swapfile corruptions</a> 2009-01-21</li>
<li><a rel="nofollow" class="external text" href="https://marc.merlins.org/perso/btrfs/post_2014-03-22_Btrfs-Tips_-Doing-Fast-Incremental-Backups-With-Btrfs-Send-and-Receive.html">Doing Fast Incremental Backups With Btrfs Send and Receive</a></li>
</ul>
</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Btrfs&amp;oldid=785428">https://wiki.archlinux.org/index.php?title=Btrfs&amp;oldid=785428</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 14 August 2023, at 11:18.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
</ul>

	
</footer>

		</div>
	</div> 
</div> 

</body>
</html>
