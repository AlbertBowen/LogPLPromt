<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>dm-verity - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.39.4">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Dm-verity rootpage-Dm-verity skin-vector-2022 action-view skin--responsive vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled">
<div class="mw-page-container">
	<span id="top-page"></span>
	<a class="mw-jump-link" href="#content">Jump to content</a>
	<div class="mw-page-container-inner">
		<input type="checkbox" id="mw-sidebar-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="vector-sidebar-container ">
			</div>
		<div class="vector-sitenotice-container">
			<div id="siteNotice"></div>
		</div>
		<input type="checkbox" id="vector-toc-collapsed-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="mw-table-of-contents-container">
			<div class="vector-sticky-toc-container mw-sticky-header-element">
				<nav id="mw-panel-toc" class="sidebar-toc" role="navigation" aria-labelledby="sidebar-toc-label" data-event-name="ui.sidebar-toc">
	<div id="sidebar-toc-label" class="sidebar-toc-header">
		<p class="sidebar-toc-title">
		Contents
		<button class="vector-toc-uncollapse-button">move to sidebar</button>
		<button class="vector-toc-collapse-button">hide</button>
		</p>
	</div>
	<ul class="sidebar-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a href="#top-page" class="sidebar-toc-link">
				<div class="sidebar-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Components" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Components">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">1</span>Components</div>
			</a>
			
			<ul id="toc-Components-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Preparation" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Preparation">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2</span>Preparation</div>
			</a>
			
				<button aria-controls="toc-Preparation-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Preparation subsection
				</button>
			
			<ul id="toc-Preparation-sublist" class="sidebar-toc-list">
				<li id="toc-Partitioning" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Partitioning">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.1</span>Partitioning</div>
			</a>
			
			<ul id="toc-Partitioning-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Possible_issues_with_boot_and_runtime" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Possible_issues_with_boot_and_runtime">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.2</span>Possible issues with boot and runtime</div>
			</a>
			
			<ul id="toc-Possible_issues_with_boot_and_runtime-sublist" class="sidebar-toc-list">
				<li id="toc-Pacman" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Pacman">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.2.1</span>Pacman</div>
			</a>
			
			<ul id="toc-Pacman-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-NetworkManager" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#NetworkManager">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2.2.2</span>NetworkManager</div>
			</a>
			
			<ul id="toc-NetworkManager-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Setting_up_verity" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Setting_up_verity">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3</span>Setting up verity</div>
			</a>
			
				<button aria-controls="toc-Setting_up_verity-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Setting up verity subsection
				</button>
			
			<ul id="toc-Setting_up_verity-sublist" class="sidebar-toc-list">
				<li id="toc-Configuring_the_kernel_command_line" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Configuring_the_kernel_command_line">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.1</span>Configuring the kernel command line</div>
			</a>
			
			<ul id="toc-Configuring_the_kernel_command_line-sublist" class="sidebar-toc-list">
				<li id="toc-Additional_recommended_options" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Additional_recommended_options">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.1.1</span>Additional recommended options</div>
			</a>
			
			<ul id="toc-Additional_recommended_options-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Devices_other_than_root" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Devices_other_than_root">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4</span>Devices other than root</div>
			</a>
			
			<ul id="toc-Devices_other_than_root-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Security_considerations" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Security_considerations">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5</span>Security considerations</div>
			</a>
			
				<button aria-controls="toc-Security_considerations-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Security considerations subsection
				</button>
			
			<ul id="toc-Security_considerations-sublist" class="sidebar-toc-list">
				<li id="toc-Secure_Boot" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Secure_Boot">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.1</span>Secure Boot</div>
			</a>
			
			<ul id="toc-Secure_Boot-sublist" class="sidebar-toc-list">
				<li id="toc-Unified_Kernel_Image" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Unified_Kernel_Image">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.1.1</span>Unified Kernel Image</div>
			</a>
			
			<ul id="toc-Unified_Kernel_Image-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Signing_kernel_modules/DKMS" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Signing_kernel_modules/DKMS">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.1.2</span>Signing kernel modules/DKMS</div>
			</a>
			
			<ul id="toc-Signing_kernel_modules/DKMS-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Encryption" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Encryption">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.2</span>Encryption</div>
			</a>
			
			<ul id="toc-Encryption-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-TPM" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#TPM">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.3</span>TPM</div>
			</a>
			
			<ul id="toc-TPM-sublist" class="sidebar-toc-list">
				<li id="toc-systemd-boot" class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#systemd-boot">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.3.1</span>systemd-boot</div>
			</a>
			
			<ul id="toc-systemd-boot-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Mandatory_access_control" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Mandatory_access_control">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5.4</span>Mandatory access control</div>
			</a>
			
			<ul id="toc-Mandatory_access_control-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Updating_packages" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Updating_packages">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6</span>Updating packages</div>
			</a>
			
				<button aria-controls="toc-Updating_packages-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Updating packages subsection
				</button>
			
			<ul id="toc-Updating_packages-sublist" class="sidebar-toc-list">
				<li id="toc-Building_images" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Building_images">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.1</span>Building images</div>
			</a>
			
			<ul id="toc-Building_images-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-A/B_update_scheme" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#A/B_update_scheme">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.2</span>A/B update scheme</div>
			</a>
			
			<ul id="toc-A/B_update_scheme-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-overlayfs" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#overlayfs">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.3</span>overlayfs</div>
			</a>
			
			<ul id="toc-overlayfs-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Flatpak" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Flatpak">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.4</span>Flatpak</div>
			</a>
			
			<ul id="toc-Flatpak-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Tips_and_tricks" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#Tips_and_tricks">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7</span>Tips and tricks</div>
			</a>
			
				<button aria-controls="toc-Tips_and_tricks-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Tips and tricks subsection
				</button>
			
			<ul id="toc-Tips_and_tricks-sublist" class="sidebar-toc-list">
				<li id="toc-Automation" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Automation">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7.1</span>Automation</div>
			</a>
			
			<ul id="toc-Automation-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-See_also" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a class="sidebar-toc-link" href="#See_also">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">8</span>See also</div>
			</a>
			
			<ul id="toc-See_also-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
</nav>

			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<a id="top"></a>
				<nav class="vector-article-toolbar" aria-label="Tools" role="navigation">
					<div class="mw-article-toolbar-container">
						<div id="left-navigation">
							

<div id="p-associated-pages" class="vector-menu mw-portlet mw-portlet-associated-pages vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-nstab-main" class="selected mw-list-item"><a href="../en/Dm-verity.html" title="View the content page [c]" accesskey="c"><span>Page</span></a></li>
<li id="ca-talk" class="mw-list-item"><a href="../en/Talk:Dm-verity.html" rel="discussion" title="Discussion about the content page [t]" accesskey="t"><span>Discussion</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-label="Change language variant">
	<label id="p-variants-label" for="p-variants-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

						</div>
						<div id="right-navigation" class="vector-collapsible ">
							

<div id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-view" class="selected mw-list-item"><a href="../en/Dm-verity.html"><span>Read</span></a></li>
<li id="ca-viewsource" class="mw-list-item"><a href="/index.php?title=Dm-verity&amp;action=edit" title="This page is protected.
You can view its source [e]" accesskey="e"><span>View source</span></a></li>
<li id="ca-history" class="mw-list-item"><a href="/index.php?title=Dm-verity&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown vector-has-collapsible-items" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox">
	<label id="p-cactions-label" for="p-cactions-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="../en/Dm-verity.html"><span>Read</span></a></li>
<li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Dm-verity&amp;action=edit"><span>View source</span></a></li>
<li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Dm-verity&amp;action=history"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

						</div>
					</div>
				</nav>
				<div id="bodyContent" class="vector-body" data-mw-ve-target-container>
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        </div>

					    <div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<p><span>
</span>
Dm-verity uses a tree of sha256 hashes to verify blocks as they are read from a block device. Consequently, this ensures files have not changed between reboots or during runtime. This is useful for extending trust to the OS by mitigating zero days and unauthorized changes to root, as well as enforcing security policies, encryption and userspace security. Verity devices are regular block devices which can be accessed in <code>/dev/mapper</code>. 
</p>
<p>dm-verity is part of the <a href="https://en.wikipedia.org/wiki/device_mapper" class="extiw" title="wikipedia:device mapper">device mapper</a> in the Linux kernel and is implemented using <a href="../en/Systemd.html" title="Systemd">systemd</a>. 
</p>
<p>This article mainly describes setting up a verity-protected read-only root partition. 
</p>
<mw:tocplace></mw:tocplace>
<h2><span class="mw-headline" id="Components">Components</span></h2>
<p>A dm-verity root setup setup consists of the following: 
</p>
<ol>
<li>a <code>/</code> root filesystem image or partition,</li>
<li>verity hash tree <code>verity.bin</code>,</li>
<li>the root hash of the verity tree <code>roothash.txt</code>,</li>
<li>
<code>systemd-veritysetup.generator</code>,</li>
<li>
<code>systemd-veritysetup@.service</code>,</li>
<li>verity <a href="../en/Kernel_parameters.html" class="mw-redirect" title="Kernel command line">kernel command line</a> options,</li>
<li>
<i>veritysetup</i> (part of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cryptsetup">cryptsetup</a></span>),</li>
<li>a <a href="../en/Unified_kernel_image.html" title="Unified kernel image">unified kernel image</a> which contains a stub EFI loader, kernel, initramfs, kernel command line, and microcode: <code>kernel.efi</code>,</li>
<li>
<a href="../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html" class="mw-redirect" title="Secure Boot">Secure Boot</a>.</li>
</ol>
<p>The unified kernel image and Secure Boot are recommended but not required. Verity is intended to be used as one of the last steps in a boot process that protects the OS and the kernel from changes. It is easily defeated without Secure Boot and unified kernel images.
</p>
<h2><span class="mw-headline" id="Preparation">Preparation</span></h2>
<p>To enable dm-verity, you must have a working system already installed and configured. See <a href="../en/Installation_guide.html" title="Installation guide">Installation guide</a> for the details.
</p>
<p>Typically, it is necessary to have a separate partition or logical volume to store the verity hash data.
</p>
<p>The recommended disk layout is similar to this: 
</p>
<h3><span class="mw-headline" id="Partitioning">Partitioning</span></h3>
<ol>
<li>EFI system partition for the boot loader (<code>LABEL=ESP</code>);</li>
<li>XBOOTLDR partition (<code>LABEL=XBOOT</code>) <div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Using systemd's XBOOTLDR partition type allows you to keep the boot loader and kernels separate. This can be useful for creating images used to install or update embedded systems and servers, but it requires you to use <a href="../en/Systemd-boot.html" title="Systemd-boot">systemd-boot</a>. It is recommended to also put the Type 1 boot loader entries into this partition.</div>
</li>
<li>Root partition (<code>LABEL=OS</code>, optionally with encryption, see <a href="../en/Data-at-rest_encryption.html" title="Data-at-rest encryption">Data-at-rest encryption</a>).</li>
<li>Verity partition (<code>LABEL=VERITY</code>), should require 8-10% the size of Root</li>
<li>Home (optional if you want write access for a user)</li>
<li>Var (many programs will not run if <code>/var</code> is not writable, so it should be separate from the root partition depending on use case)</li>
</ol>
<dl><dd><div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Using file system labels instead of UUIDs simplifies deploying images on embedded devices. Two devices will have differing partition UUIDs making bundling cmdline into a <a href="../en/Unified_kernel_image.html" class="mw-redirect" title="UKI">UKI</a> difficult.</div></dd></dl>
<p><code>/home</code> and <code>/var</code> should be writable filesystems. On a server that just has one purpose this may be optional, since e.g. a wireguard server needs no write access to the disk.
</p>
<p><span class="plainlinks archwiki-template-man" title="$ man 1 mkfs.erofs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.erofs.1">mkfs.erofs(1)</a></span> offers an attractive alternative to ext4 or squashfs on the root partition. EROFS, like squashfs, does not allow writes by design and has better performance in many cases than comparable filesystems on flash and solid-state media. It uses lz4 compression by default and was designed for Android phones by Huawei, which make extensive use of dm-verity.
</p>
<h3><span class="mw-headline" id="Possible_issues_with_boot_and_runtime">Possible issues with boot and runtime</span></h3>
<p>Any files that need to be written to during init or changed during runtime must be made writable by some method otherwise the program will not function as expected. 
</p>
<p>Many programs need write access to <code>etc</code>. You can use a separate <code>/etc</code> partition but this will make <b>all</b> of these configuration files writable. Create a folder <code>/var/etc</code> and move the files that need write access into it than symlink into <code>etc</code>, as with the example with NetworkManager below.
</p>
<p>Some programs will expect these folders and files to still exist (even read-only) on the root filesystem for early init. For instance, <i>systemd-journald</i> will break if <code>/etc/machine-id</code> does not exist or is a symlink. Bind mounts can be useful for this. 
</p>
<p>One way to find out which files will change when the system is running is to enable the <code>dracut-overlayroot</code> module, use the system, and check the files in <code>/run/overlayroot/u</code> to see what you may need to address. Any files in this folder were written to the tmpfs overlaid on top of root. Place the module into <code>/usr/lib/dracut/modules.d/</code>, add <code>overlayroot</code> to the <a href="../en/Dracut.html" title="Dracut">dracut</a> modules list, and <code>overlayroot=1</code> to your kernel command line and <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>. The module can be found at <a rel="nofollow" class="external free" href="https://github.com/TylerHelt0/dracut-overlayroot">https://github.com/TylerHelt0/dracut-overlayroot</a><sup title="Last check status: 404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2023-05-06 ⓘ]</sup>.
</p>
<h4><span class="mw-headline" id="Pacman">Pacman</span></h4>
<p>Since the root filesystem will be mounted read-only and <code>/var</code> should be mounted read-write in most cases, the path to the <i>pacman</i> database should be changed to <code>/usr/lib/pacman</code>. This will ensure the rootfs always has the correct list of installed packages. 
</p>
<ol>
<li><code>cp /var/lib/pacman /usr/lib </code></li>
<li>
<a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Textedit">Edit</a> <code>/etc/pacman.conf</code> and set <code>DBPath = /usr/lib/pacman</code>
</li>
<li>To be able to sync lists and check updates, move <code>/usr/lib/pacman/cache</code> to <code>/var/lib/pacman</code> and symlink it.</li>
<li>If you wish to be able to change mirrorlist without modifying the root file system, move it to <code>/var/etc</code> and symlink it as well.</li>
</ol>
<h4><span class="mw-headline" id="NetworkManager">NetworkManager</span></h4>
<p>To setup connections with <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a>, you need write access to <code>/etc/NetworkManager/system-connections</code>. Move the <code>system-connections</code> folder to <code>/var/etc/NetworkManager/system-connections</code> and symlink to it on the root filesystem.
</p>
<pre># ln -sf /etc/NetworkManager/system-connections /var/etc/NetworkManager/system-connections
</pre>
<h2><span class="mw-headline" id="Setting_up_verity">Setting up verity</span></h2>
<ol>
<li>Boot from a live medium</li>
<li>Mount your root filesystem as read-only</li>
<li>Make sure all your changes are perfect</li>
<li>do <code>veritysetup format &lt;root device&gt; &lt;verity device&gt; | grep Root | cut -f2 &gt;&gt; roothash.txt</code>
</li>
</ol>
<p>You will now have the rootfs, the verity hash tree, and the roothash. Alternatively you can save the hashes to a file by replacing the <code>&lt;verity device&gt;</code> path and write it to the device later. 
</p>
<p>To test it you can use <code>veritysetup open &lt;root device&gt; root &lt;verity device&gt; $(cat roothash.txt)</code>. The verity device can be mounted from <code>/dev/mapper/root</code>.
</p>
<h3><span class="mw-headline" id="Configuring_the_kernel_command_line">Configuring the kernel command line</span></h3>
<p>Add the following options to your kernel command line:
</p>
<ol>
<li><code>systemd.verity=1</code></li>
<li><code>roothash=<i>contents_of_roothash.txt</i></code></li>
<li><code>systemd.verity_root_data=<i>PATH-TO-ROOT, e.g. LABEL=Root</i></code></li>
<li><code>systemd.verity_root_hash=<i>PATH-TO-VERITY-PARTITION, e.g. LABEL=Verity</i></code></li>
<li>
<code>systemd.verity_root_options=restart-on-corruption</code> or <code>panic-on-corruption</code> (the default behavior will just print an error to <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a> and will not prevent untrusted code from running)</li>
</ol>
<p>If the roothash changes you must also edit the cmdline/rebuild the Unified Kernel Image with the new value. Failure to do so can result in an unbootable system. 
</p>
<h4><span class="mw-headline" id="Additional_recommended_options">Additional recommended options</span></h4>
<ol>
<li>
<code>ro</code> to prevent changes to root if not using erofs or squashfs</li>
<li>
<code>rd.emergency=reboot</code> to prevents access to a shell if the root is corrupt</li>
<li>
<code>rd.shell=0</code> to prevents access to a shell if boot fails</li>
<li>
<code>lsm=lockdown</code> enables kernel lockdown mode, requires signed kernel modules</li>
<li>
<code>lockdown=confidentiality</code> prevents users from accessing kernel memory</li>
</ol>
<h2><span class="mw-headline" id="Devices_other_than_root">Devices other than root</span></h2>
<p>The use of <i>dm-verity</i> is not limited to the root device. Other devices that need to be verified at boot can be put into <code>/etc/veritytab</code> and will be assembled by <code>systemd-veritysetup@.service</code>. See <span class="plainlinks archwiki-template-man" title="$ man 5 veritytab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/veritytab.5">veritytab(5)</a></span> for more information.
</p>
<p>Be aware that it is much easier to remount a non-root partition as RW while the system is running. Integrity violations also will not trigger a reboot. Even if <code></code> has verity enabled, it is trivial for a user with root privileges to disable verity on a non-root partition. 
</p>
<h2><span class="mw-headline" id="Security_considerations">Security considerations</span></h2>
<p>dm-verity does not provide an all-in-one solution but should be used alongside other methods of securing the system when the disk is removed and when the system is fully booted. 
</p>
<h3><span class="mw-headline" id="Secure_Boot">Secure Boot</span></h3>
<p>It is recommended to enable <a href="../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html" class="mw-redirect" title="Secure Boot">Secure Boot</a> with custom keys after verity is setup.
</p>
<p>Verity protection is useless if a virus or attacker can replace the <code>kernel.efi</code> containing the embedded roothash which would allow any root filesystem to be booted. Signing the kernel image for Secure Boot will prevent the kernel image from being replaced and ensure integrity of the root filesystem as long as the firmware is secure. 
</p>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/sbupdate-git/">sbupdate-git</a></span><sup><small>AUR</small></sup> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=sbctl">sbctl</a></span> can be used to maintain your Unified kernel images and keep your bootloader signed. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/sbupdate-git/">sbupdate-git</a></span><sup><small>AUR</small></sup> will also handle your kernel command line. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=sbctl">sbctl</a></span> can be used to create Secure Boot keys.
</p>
<h4><span class="mw-headline" id="Unified_Kernel_Image">Unified Kernel Image</span></h4>
<p>UKIs bundle together at minimum the linux kernel, an initramfs, CPU microcode, and a cmdline. The advantage to using an UKI is that it prevents changes to both the kernel, initramfs and cmdline when the UKI is signed and used with secureboot. If the cmdline section of the UKI is left blank, it can be supplied by a bootloader like systemd-boot. Otherwise it can only be changed by rebuilding and resigning a new UKI.
</p>
<p>UKIs can be directly booted by UEFI if kernel efistub is enabled or if shim/preloader is used. 
</p>
<h4>
<span id="Signing_kernel_modules.2FDKMS"></span><span class="mw-headline" id="Signing_kernel_modules/DKMS">Signing kernel modules/DKMS</span>
</h4>
<p>The default kernels ship with pre-signed native modules. If <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="DKMS">DKMS</a> is used, one must create a custom kernel to enable signing and loading of DKMS modules when secureboot is enabled which activates lockdown mode. If you skip this step DKMS modules will refuse to load. 
</p>
<p>More information about signed kernel modules can be found here: <a href="../en/Signed_kernel_modules.html" title="Signed kernel modules">Signed kernel modules</a>
</p>
<h3><span class="mw-headline" id="Encryption">Encryption</span></h3>
<p>Although the verity root device will be tamper-resistant, it provides no confidentiality. It could be located on an unencrypted partition if it contains no secret data. If the kernel is protected by Secure Boot, it would be impossible to replace the data in the root or verity devices without replacing the kernel. 
</p>
<p>The verity root device can be used to unlock other encrypted devices. If done with keyfiles, the verity root <b>should</b> be encrypted. If using a TPM and <i>systemd-cryptenroll</i> to store keys, the verity root could be unencrypted. 
</p>
<h3><span class="mw-headline" id="TPM">TPM</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-cryptenroll"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptenroll.1">systemd-cryptenroll(1)</a></span> recommends PCR7 only (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Dm-verity">Talk:Dm-verity</a>)</div>
</div>
<p>A <a href="../en/Trusted_Platform_Module.html" class="mw-redirect" title="TPM">TPM</a> 2.0 can be used to protect encryption keys for the LUKS device containing root. After Secure Boot is enabled, you can use <code>systemd-cryptenroll</code> to bind keys to PCRs. Recommended PCRs are 0,1,5,7. This will stop decryption if the firmware, firmware options, GPT layout or secure boot state is changed, respectively. 
</p>
<p>The reason for binding on 0,1, and 5 is to ensure attackers cannot replace the motherboard firmware to disable secureboot and consequently disable verity. 
</p>
<p>You must pass this kernel option:
</p>
<pre>rd.luks.options=<i>UUID_of_LUKS</i>=tpm2-device=auto
</pre>
<p>You may also need to add tpm2 support to your initramfs or include the module if using dracut. See <a href="../en/Trusted_Platform_Module.html#systemd-cryptenroll" title="Trusted Platform Module">Trusted Platform Module#systemd-cryptenroll</a> for more information.
</p>
<h4><span class="mw-headline" id="systemd-boot">systemd-boot</span></h4>
<p>If you use <a href="../en/Systemd-boot.html" title="Systemd-boot">systemd-boot</a> as your bootloader, it will measure the <code>kernel.efi</code> into PCR 4. This can be used to prevent decryption of root if the kernel image, initramfs, or kernel command line is changed.
</p>
<h3><span class="mw-headline" id="Mandatory_access_control">Mandatory access control</span></h3>
<p>During runtime, methods such as OverlayFS, tmpfs, and bind mounts can still be used to get write access on the folders within <code>root</code>. For this reason, it is important to still harden the OS. Apparmor, SELinux and other access control mechanisms are useful for this.
</p>
<h2><span class="mw-headline" id="Updating_packages">Updating packages</span></h2>
<p>A dm-verity read-only root should not be updated the traditional way with pacman. Verity is intended mostly for embedded devices and others which value code-integrity over the rolling release model. This has the primary benefits of extending trust to the OS and ensuring a device always boots the same way. E.g. an emulator box for normies or a secure web server. dm-verity, combined with other security methods like selinux, eliminate entire classes of zero-days and consequently the need to update is less frequent unless new features are desired. Think about a router running linux: many routers are compromised by malware without the user ever knowing. If the router was verity-protected in a secure way, it would prevent viruses from gaining persistence. 
</p>
<p>You could use ext4 for <code>/</code> which enables you to mount it rw. You can then do updates, rehash the filesystem, and change the roothash in the cmdline, but it would be better to release incrementally updated images of the filesystems. Disabling verity to do updates on a writable filesystem is as simple as omitting the systemd.verity=1 cmdline option. 
</p>
<h3><span class="mw-headline" id="Building_images">Building images</span></h3>
<p>A VM can be used to maintain a 'rolling' system and imaged when updates are needed. A chroot could work as well. Setup all the partitioning and boot logic the way it is expected to work on the target system, than reboot the VM into a live media and make images of the partitions. If you image the xboot partition, it can be flashed directly to a partition to update the UKI/kernel/initramfs/cmdline. If paired with an image for the root filesystem this is more or less a complete system update. 
</p>
<p>Systemd already has the logic to retrieve images from an update server (Or local dir) and flash them to partitions which may or may not already exist. It can also install and remove files into existing partitions. 
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-sysupdate"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-sysupdate.8">systemd-sysupdate(8)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-repart"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-repart.8">systemd-repart(8)</a></span>. 
</p>
<h3>
<span id="A.2FB_update_scheme"></span><span class="mw-headline" id="A/B_update_scheme">A/B update scheme</span>
</h3>
<p>Another way to handle updates would be to use a system similar to Android's A/B partition system. This entails having two sets of the root and verity partitions. When an update is necessary the active partition could be copied to the inactive one. The inactive partition could than be updated as normal from chroot or with pacman and 'sealed' with dm-verity. On next boot, the inactive partition becomes the active partition. 
</p>
<p>If using UKI the UKI must be updated with the root and verity partitions. At minimum the kernel cmdline must be updated with new roothash.
</p>
<h3><span class="mw-headline" id="overlayfs">overlayfs</span></h3>
<p>If the user wants a system that has optional persistence or can install packages which are reverted at reboot, an overlay can be mounted as root with the verity root as the lower dir. The upper dir could be a persistent block device or a tmpfs. If using A/B, one could remount <code>/</code> as a writable OverlayFS and use normal update methods, than copy the contents of the overlayfs into the inactive partition and rehash verity.
</p>
<p>If the user requires temporary persistence (for example, the ability to install packages that are reset at boot),  <code>systemd.volatile=overlay</code> can be passed on the kernel command line.
</p>
<h3><span class="mw-headline" id="Flatpak">Flatpak</span></h3>
<p>Flatpak can be used to install and update apps within <code>var</code> and <code>home</code> without write access to <code>/</code>. Flatpak would be ideal to solve most user's needs for installing applications and updating them in a verity-protected desktop PC. Flatpak works on <code>/var</code> by default.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Automation">Automation</span></h3>
<p>The above steps can be automated with the package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/verity-squash-root/">verity-squash-root</a></span><sup><small>AUR</small></sup>. It will build a squashfs rootfs and sign the roothash with the kernel and the initramfs. On boot, you can decide to boot a persistent system, where changes on the overlayfs are saved, or to boot a volatile system. It also keeps the last rootfs as a backup, so you can decide to boot the last working rootfs.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  Adding persistence to a verity protected partition can be useful in narrow situations but should be avoided. Verity was designed to ensure files do not change while the system is running or turned off. Try to persist application specific data in separate partitions.</div>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><span class="plainlinks archwiki-template-man" title="$ man 8 systemd-veritysetup@.service"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-veritysetup%40.service.8">systemd-veritysetup@.service(8)</a></span></li>
<li><span class="plainlinks archwiki-template-man" title="$ man 8 systemd-veritysetup-generator"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-veritysetup-generator.8">systemd-veritysetup-generator(8)</a></span></li>
<li><span class="plainlinks archwiki-template-man" title="$ man 8 veritysetup"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/veritysetup.8">veritysetup(8)</a></span></li>
<li><span class="plainlinks archwiki-template-man" title="$ man 1 systemd-cryptenroll"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptenroll.1">systemd-cryptenroll(1)</a></span></li>
<li><a rel="nofollow" class="external text" href="https://github.com/Foxboron/sbctl">GitHub page for sbctl</a></li>
<li><a rel="nofollow" class="external text" href="https://github.com/andreyv/sbupdate">GitHub page for sbudate</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Security.html" title="Category:Security">Security</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-verity&amp;oldid=785792">https://wiki.archlinux.org/index.php?title=Dm-verity&amp;oldid=785792</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 20 August 2023, at 08:40.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
</ul>

	
</footer>

		</div>
	</div> 
</div> 

</body>
</html>
